name: OSS Issue and Discussion Triage

# This workflow automatically triggers AI triage for issues and discussions opened by
# community members (users without write access to the repository). It helps provide
# quick initial responses and escalates actionable items to the internal oncall team.

on:
  issues:
    types: [opened]
  discussion:
    types: [created]

permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  check-permissions:
    name: Resolve Input Variables
    runs-on: ubuntu-24.04
    steps:
      - name: Gather event metadata
        id: gather-metadata
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
            echo "event-type=issue" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "discussion" ]]; then
            echo "author=${{ github.event.discussion.user.login }}" >> $GITHUB_OUTPUT
            echo "event-type=discussion" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Check if user has write access
        id: check-access
        env:
          GH_TOKEN: ${{ steps.get-app-token.outputs.token }}
          AUTHOR: ${{ steps.gather-metadata.outputs.author }}
        run: |
          set -euo pipefail

          echo "Checking permissions for user: $AUTHOR"

          # Get the user's permission level for this repository
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/$AUTHOR/permission \
            --jq '.permission' 2>/dev/null || echo "none")

          echo "User permission level: $PERMISSION"

          # Users with write, maintain, or admin access are NOT community members
          # Users with read or no access ARE community members
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "maintain" || "$PERMISSION" == "write" ]]; then
            echo "User has write access - skipping AI triage"
            echo "is-community-member=false" >> $GITHUB_OUTPUT
          else
            echo "User is a community member - triggering AI triage"
            echo "is-community-member=true" >> $GITHUB_OUTPUT
          fi
    outputs:
      is-community-member: ${{ steps.check-access.outputs.is-community-member }}
      author: ${{ steps.gather-metadata.outputs.author }}
      event-type: ${{ steps.gather-metadata.outputs.event-type }}

  ai-triage-issue:
    name: AI Triage for Community Issue
    needs: check-permissions
    if: needs.check-permissions.outputs.event-type == 'issue'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte,oncall"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Run AI Triage
        uses: aaronsteers/devin-action@v0.2.0
        with:
          issue-number: ${{ github.event.issue.number }}
          playbook-macro: "!oss_issue_triage"
          devin-token: ${{ secrets.DEVIN_AI_API_KEY }}
          github-token: ${{ steps.get-app-token.outputs.token }}
          start-message: |
            **AI Triage Starting...**

            Thank you for opening this issue! I'm an AI assistant that will do an initial review and may:
            - Ask clarifying questions if needed
            - Suggest relevant documentation or workarounds
            - Flag this for internal visibility

            **Note:** Community issues are reviewed on a best-effort basis and do not have a guaranteed response time. For additional help:
            - Join the [Airbyte Community Slack](https://slack.airbyte.com) to connect with other users and community members
            - If you're an Airbyte Cloud customer, you can [open a support ticket](https://support.airbyte.com) or contact your account representative, referencing this issue URL

            [View playbook](https://github.com/airbytehq/oncall/blob/main/prompts/playbooks/oss_issue_triage.md)
          tags: |
            oss-issue-triage
            community-issue

  ai-triage-discussion:
    name: AI Triage for Community Discussion
    needs: check-permissions
    if: needs.check-permissions.outputs.event-type == 'discussion'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte,oncall"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Prepare discussion prompt
        id: prepare-prompt
        env:
          DISC_NUM: ${{ github.event.discussion.number }}
          DISC_AUTHOR: ${{ github.event.discussion.user.login }}
          DISC_TITLE: ${{ github.event.discussion.title }}
          DISC_URL: ${{ github.event.discussion.html_url }}
          DISC_CAT: ${{ github.event.discussion.category.name }}
          DISC_BODY: ${{ github.event.discussion.body }}
          DISC_NODE_ID: ${{ github.event.discussion.node_id }}
        run: |
          escape_for_bash() {
            local text="$1"
            text="${text//\\/\\\\}"
            text="${text//\`/\\\`}"
            text="${text//\$/\\\$}"
            text="${text//\"/\\\"}"
            printf '%s' "$text"
          }

          ESC_TITLE=$(escape_for_bash "$DISC_TITLE")
          ESC_BODY=$(escape_for_bash "$DISC_BODY")

          {
            echo "prompt<<PROMPT_EOF"
            printf 'Discussion #%s by @%s: %s\n' "$DISC_NUM" "$DISC_AUTHOR" "$ESC_TITLE"
            printf 'Discussion URL: %s\n' "$DISC_URL"
            printf 'Discussion Category: %s\n' "$DISC_CAT"
            echo ""
            echo "Discussion Body:"
            printf '%s\n' "$ESC_BODY"
            echo ""
            printf 'IMPORTANT: This is a GitHub Discussion, not an issue. You should post your response as a comment on the discussion using the GitHub GraphQL API. The discussion node ID is: %s\n' "$DISC_NODE_ID"
            echo "PROMPT_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run AI Triage
        uses: aaronsteers/devin-action@v0.2.0
        with:
          playbook-macro: "!oss_issue_triage"
          devin-token: ${{ secrets.DEVIN_AI_API_KEY }}
          github-token: ${{ steps.get-app-token.outputs.token }}
          prompt-text: ${{ steps.prepare-prompt.outputs.prompt }}
          tags: |
            oss-issue-triage
            community-discussion
