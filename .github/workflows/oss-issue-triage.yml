name: OSS Issue and Discussion Triage

# This workflow automatically triggers AI triage for issues and discussions opened by
# community members (users without write access to the repository). It helps provide
# quick initial responses and escalates actionable items to the internal oncall team.

on:
  issues:
    types: [opened]
  discussion:
    types: [created]

permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  check-permissions:
    name: Resolve Input Variables
    runs-on: ubuntu-24.04
    steps:
      - name: Gather event metadata
        id: gather-metadata
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
            echo "event-type=issue" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "discussion" ]]; then
            echo "author=${{ github.event.discussion.user.login }}" >> $GITHUB_OUTPUT
            echo "event-type=discussion" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Check if user has write access
        id: check-access
        env:
          GH_TOKEN: ${{ steps.get-app-token.outputs.token }}
          AUTHOR: ${{ steps.gather-metadata.outputs.author }}
        run: |
          set -euo pipefail

          echo "Checking permissions for user: $AUTHOR"

          # Get the user's permission level for this repository
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/$AUTHOR/permission \
            --jq '.permission' 2>/dev/null || echo "none")

          echo "User permission level: $PERMISSION"

          # Users with write, maintain, or admin access are NOT community members
          # Users with read or no access ARE community members
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "maintain" || "$PERMISSION" == "write" ]]; then
            echo "User has write access - skipping AI triage"
            echo "is-community-member=false" >> $GITHUB_OUTPUT
          else
            echo "User is a community member - triggering AI triage"
            echo "is-community-member=true" >> $GITHUB_OUTPUT
          fi
    outputs:
      is-community-member: ${{ steps.check-access.outputs.is-community-member }}
      author: ${{ steps.gather-metadata.outputs.author }}
      event-type: ${{ steps.gather-metadata.outputs.event-type }}

  ai-triage-issue:
    name: AI Triage for Community Issue
    needs: check-permissions
    if: needs.check-permissions.outputs.event-type == 'issue'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte,oncall"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Run AI Triage
        uses: aaronsteers/devin-action@v0.2.0
        with:
          issue-number: ${{ github.event.issue.number }}
          playbook-macro: "!oss_issue_triage"
          devin-token: ${{ secrets.DEVIN_AI_API_KEY }}
          github-token: ${{ steps.get-app-token.outputs.token }}
          start-message: |
            **AI Triage Starting...**

            Thank you for opening this issue! I'm an AI assistant that will do an initial review and may:
            - Ask clarifying questions if needed
            - Suggest relevant documentation or workarounds
            - Flag this for internal visibility

            **Note:** Community issues are reviewed on a best-effort basis and do not have a guaranteed response time. For additional help:
            - Join the [Airbyte Community Slack](https://slack.airbyte.com) to connect with other users and community members
            - If you're an Airbyte Cloud customer, you can [open a support ticket](https://support.airbyte.com) or contact your account representative, referencing this issue URL

            [View playbook](https://github.com/airbytehq/oncall/blob/main/prompts/playbooks/oss_issue_triage.md)
          tags: |
            oss-issue-triage
            community-issue

  ai-triage-discussion:
    name: AI Triage for Community Discussion
    needs: check-permissions
    if: needs.check-permissions.outputs.event-type == 'discussion'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte,oncall"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Run AI Triage
        uses: aaronsteers/devin-action@v0.2.0
        with:
          playbook-macro: "!oss_issue_triage"
          devin-token: ${{ secrets.DEVIN_AI_API_KEY }}
          github-token: ${{ steps.get-app-token.outputs.token }}
          prompt-text: |
            Discussion #${{ github.event.discussion.number }} by @${{ github.event.discussion.user.login }}: ${{ github.event.discussion.title }}
            Discussion URL: ${{ github.event.discussion.html_url }}
            Discussion Category: ${{ github.event.discussion.category.name }}

            Discussion Body:
            ${{ github.event.discussion.body }}

            IMPORTANT: This is a GitHub Discussion, not an issue. You should post your response as a comment on the discussion using the GitHub GraphQL API. The discussion node ID is: ${{ github.event.discussion.node_id }}
          tags: |
            oss-issue-triage
            community-discussion
